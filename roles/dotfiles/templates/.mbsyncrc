# {{ ansible_managed }}
# Settings for isync, a program to syncronise IMAP mailboxes
# This file defines the syncronisation for two accounts, Personal and Work
# The remote for each account is a server somewhere, and the local is a folder
# in ~/.mail
# Syncronise everything with `mbsync -a`

########################################
# Default settings
# Applied to all channels
########################################
Create Slave
Expunge Both
SyncState *
{% for account in mail_accounts %}
{% if account.imap_user != '' %}
########################################
# {{ account.name }}
########################################
IMAPAccount {{ account.name }}
Host {{ account.imap_server }}
User {{ account.imap_user }}
# Get the account password from the system Keychain
PassCmd "~/.config/zsh/bin/get-keychain-pass '{{ account.imap_keychain_account }}' '{{ account.imap_keychain_name }}'"
AuthMechs LOGIN
SSLType IMAPS
SSLVersions TLSv1.2

# Remote storage (where the mail is retrieved from)
IMAPStore {{ account.name }}-remote
Account {{ account.name }}

# Local storage (where the mail is retrieved to)
MaildirStore {{ account.name }}-local
Path ~/.mail/{{ account.name }}/ # The trailing "/" is important
Inbox ~/.mail/{{ account.name }}/INBOX
SubFolders Verbatim

Channel {{ account.name }}-inbox
Master :{{ account.name }}-remote:INBOX
Slave :{{ account.name }}-local:INBOX

Channel {{ account.name }}-archive
{% if keychain_name == 'fastmail.com' %}
Master :{{ account.name }}-remote:Archive
{% else %}
Master :{{ account.name }}-remote:"[Gmail]/All Mail"
{% endif %}
Slave :{{ account.name }}-local:Archive

Channel {{ account.name }}-drafts
{% if keychain_name == 'fastmail.com' %}
Master :{{ account.name }}-remote:Drafts
{% else %}
Master :{{ account.name }}-remote:"[Gmail]/Drafts"
{% endif %}
Slave :{{ account.name }}-local:Drafts

{% if keychain_name == 'gmail.com' %}
Channel {{ account.name }}-starred
Master :{{ account.name }}-remote:"[Gmail]/Starred"
Slave :{{ account.name }}-local:Starred
{% endif %}

Channel {{ account.name }}-sent
{% if keychain_name == 'fastmail.com' %}
Master :{{ account.name }}-remote:Sent
{% else %}
Master :{{ account.name }}-remote:"[Gmail]/Sent Mail"
{% endif %}
Slave :{{ account.name }}-local:Sent

Channel {{ account.name }}-spam
{% if keychain_name == 'fastmail.com' %}
Master :{{ account.name }}-remote:Spam
{% else %}
Master :{{ account.name }}-remote:"[Gmail]/Spam"
{% endif %}
Slave :{{ account.name }}-local:Spam

Channel {{ account.name }}-trash
{% if keychain_name == 'fastmail.com' %}
Master :{{ account.name }}-remote:Trash
{% else %}
Master :{{ account.name }}-remote:"[Gmail]/Trash"
{% endif %}
Slave :{{ account.name }}-local:Trash

Channel {{ account.name }}-folders
Master :{{ account.name }}-remote:
Slave :{{ account.name }}-local:
# All folders except those defined above
Patterns * !INBOX !Archive !Drafts {% if keychain_name == 'gmail.com' %}!Starred {% endif %}!Sent !Spam !Trash ![Gmail]*

# Group the channels, so that all channels can be sync'd with `mbsync {{ account.name | lower }}`
Group {{ account.name | lower }}
Channel {{ account.name }}-inbox
Channel {{ account.name }}-archive
Channel {{ account.name }}-drafts
{% if keychain_name == 'gmail.com' %}
Channel {{ account.name }}-starred
{% endif %}
Channel {{ account.name }}-sent
Channel {{ account.name }}-spam
Channel {{ account.name }}-trash
Channel {{ account.name }}-folders

# For doing a quick sync of just the INBOX with `mbsync {{ account.name | lower }}-download`.
Channel {{ account.name | lower }}-download
Master :{{ account.name }}-remote:INBOX
Slave :{{ account.name }}-local:INBOX
Create Slave
Expunge Slave
Sync Pull

{% endif %}
{% endfor %}
